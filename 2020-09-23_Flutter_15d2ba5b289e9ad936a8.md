<!--
title:   flutterのテストの方法を検討する
tags:    Flutter
id:      15d2ba5b289e9ad936a8
private: true
-->
# 概要
flutterで開発しているアプリに対し、上司が以下のテストを要求している

1. C0網羅率100%[^1]のホワイトボックステスト
2. 何らかのドキュメント[^2]に基づいたブラックボックステスト

ブラックボックステストは別に考えるとして、まずホワイトボックステストについて考える
また、C0網羅率100%も一旦後回しにして、テストを簡単に実行することだけに焦点を絞る

<!--
網羅率100\%、前のプロジェクトではできたよ？」とか言うけど、面倒臭いパスにコメント入れてカバレッジ計測対象から外す作業やりまくった結果だって知ってるからな！自分でテスト書かないやつはすぐ網羅率100%とか言うんだよ
-->

# 方針
* flutterでなるべく楽にテストできるようにテスト方法を定義する
    * CI/CDは別チーム担当なのでインフラは考えないでOK
    * テストに使用するツールやパッケージを決める
    * コーディングテクニック的なものも駆使してテストケースを減らす
    * 'テスト不要なパス'を定義する(機械的に判断できる条件にする)
* 上司に「十分テストできてますよ！」と納得させるための仕組みを考える
* 網羅率を楽に上げるための工夫はここでは考えない(後回し)

# 目次

* テストの構造を整理する
* テストの実行方法を確認する
* テストを実行するにあたって発生する問題と解決方法を調査する


# テストの構造を整理する
flutterにはUnit,Widget,Integrationの3種類のテストがある[^3]
一方、指示されているのはホワイトボックステストである。単位が違うため、関係を整理する

||対象|対応するテスト方法|
|---|---|---|
|ホワイトボックステスト|Widgetでないクラス　　　　　　|Unitテスト|
|                  |WidgetだがGUIを持たないクラス|Unitテスト|
|　　　　　　　　　　　|Widgetであり、GUIを持つクラス|Widgetテスト|

ちょっと書いてみた感じ、別にUnitテストとWidgetテストを殊更区別する必要はないと思う
Widgetテストであれば、ユーザ操作を模擬できる、というだけ

# テストの実行方法を確認する
以下のコマンドでテストを実施し、結果をhtmlで出力できる
どうやら、flutterは実行時にはunitテストとwigetテストを区別しないらしい

```bash
dev@dev:~/work/git/CoverageTest$ flutter test --coverage;
dev@dev:~/work/git/CoverageTest$ genhtml coverage/lcov.info -o coverage/html
```

生成されるhtmlは以下の通り
右上の'Lines'の項目でC0を出してくれているようなので、こいつをC0として納得してもらうことにする
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/185272/818e82b4-5c5e-e0c4-7c00-766ce1cc3a41.png)

# テストを実行するにあたって発生する問題と解決方法を調査する
### 調査の方針
これまでの調査でテストを実施することはできることがわかっている
よって、以下の流れで問題と解決方法を調査する

* 問題をリストアップする
    * テストを実行するにあたって発生する問題をリストアップする
* 解決方法を調査する
    * リストアップした問題をそれぞれ解決する方法やツール・パッケージを調査する

### 問題をリストアップする

|問題|詳細|
|:--|:--|
|Widgetをテストする際、子Widgetをmock化する術がない||
|改修する度にホワイトボックステストを再度作り直しになり、無駄||
|テストケースを洗い出すのが面倒臭い||
|Mockクラスを作るのが面倒臭い||
|誰がいつテストを記述するのか、明確でない||
|testディレクトリの構造を定義していない||
|不要なテスト(複雑度1の関数のテスト)が多い||


### 解決方法を調査する
#### Widgetをテストする際、子Widgetをmock化する術がない
pubspec.yamlの先頭行のname:***を書き換える
これによって、"package:***"で指定したimport先を変更することができる


https://itome.team/blog/2019/12/flutter-advent-calendar-day20/





[^1]: どうせ100%は無理なので、'100%を目指すつもりでやれ'という命令と解釈する
[^2]: ドキュメントがない(!)ので、どんなドキュメントを作るかから考える必要がある
[^3]: https://flutter.dev/docs/testing